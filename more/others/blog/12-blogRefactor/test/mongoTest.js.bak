/* eslint-env mocha */
const expect = require('chai').expect
const db = require('../db')

describe('MongoDB 測試', function () {
  before(function () {
    db.open('blogmvc', 'mongodb://127.0.0.1:27017/')
  })
  after(function () {
    db.close()
  })

  describe('get board:ccc', function () { // 路徑 GET /
    it('取得 board:ccc', async function () {
      let boardList = await db.select('boards')
      expect(boardList).to.have.lengthOf(2)
      console.log('boardList=', boardList)
      
    })
    it('取得 board:ccc', async function () {
      let boardList = await db.select('boards')
      expect(boardList).to.have.lengthOf(2)
      console.log('boardList=', boardList)
    })
  })
/*
  describe('GET /ccc/posts', function () { // 路徑 GET /
    it('內文標題應該為 《ccc 的留言板》，而且有 3 則貼文', function (done) {
      request.get('/ccc/posts').expect(200, function (err, res) {
        if (err) return done(err)

        expect(res.header['content-type']).to.include('html') // 根目錄是個 html 文件
        expect(res.text).to.include('ccc 的留言板')
        expect(res.text).to.include('總共有 <strong>3</strong> 則貼文!')
        done()
      })
    })
  })

  describe('GET /ccc/post/0', function () { // 路徑 GET /
    it('內文標題應該為 週三上網站設計', function (done) {
      request.get('/ccc/post/0').expect(200, function (err, res) {
        if (err) return done(err)

        expect(res.header['content-type']).to.include('html') // 根目錄是個 html 文件
        expect(res.text).to.include('週三上網站設計')
        done()
      })
    })
  })

  describe('POST /george/post', function () { // 路徑 POST /post/new
    it('應該會貼文失敗，因為還沒有註冊', function (done) {
      request
        .post('/george/post')
        .send({ title: '貼文 0', body: '內容 0' })
        .expect(401, function (err, res) {
          if (err) return done(err)

          done()
        })
    })
  })

  describe('signup ; login ; post', function () {

    describe('POST /signup (user:george, password:george123)', function () {
      it('應該會登入成功', function (done) {
        request
          .post('/signup')
          .send({ user: 'george', password: 'george123', email: 'geroge@gmail.com' })
          .expect(200, function (err, res) {
            if (err) return done(err)

            done()
          })
      })
    })

    describe('POST /login (user:george, password:george123)', function () {
      it('應該會登入成功', function (done) {
        request
          .post('/login')
          .send({ user: 'george', password: 'george123' })
          .expect(302, function (err, res) {
            if (err) return done(err)

            expect(res.header.location).to.equal('/george/posts')
            done()
          })
      })
    })

    describe('POST /george/post', function () { // 路徑 POST /post/new
      it('應該會貼文成功，已經登入了', function (done) {
        request
          .post('/george/post')
          .send({ title: '貼文 0', body: '內容 0' })
          .expect(302, function (err, res) {
            if (err) return done(err)

            expect(res.header.location).to.equal('/george/posts')
            done()
          })
      })
    })

    describe('GET /george/post/0', function () { // 路徑 GET /
      it('內文標題應該為 <h2>貼文 0</h2>', function (done) {
        request.get('/george/post/0').expect(200, function (err, res) {
          if (err) return done(err)

          expect(res.text).to.include('<h2>貼文 0</h2>')
          done()
        })
      })
    })

    describe('GET /george/posts', function () { // 路徑 GET /
      it('內文標題應該為 《george 的留言板》，而且有 1 則貼文', function (done) {
        request.get('/george/posts').expect(200, function (err, res) {
          if (err) return done(err)

          expect(res.header['content-type']).to.include('html') // 根目錄是個 html 文件
          expect(res.text).to.include('george 的留言板')
          expect(res.text).to.include('總共有 <strong>1</strong> 則貼文!')
          done()
        })
      })
    })
  })
*/
})
